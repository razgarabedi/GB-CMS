<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Digital Signage Admin</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 1rem auto; max-width: 1000px; padding: 0 1rem; background: #0f172a; color: #e2e8f0; }
      header { display: flex; align-items: center; justify-content: space-between; }
      h1 { margin: 0.5rem 0; }
      h2 { margin: 1rem 0 0.5rem; }
        h3 { margin: 0.75rem 0 0.5rem; font-size: 1.05rem; color: #cbd5e1; }
      table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { border: 1px solid #1e293b; padding: 0.5rem; text-align: left; }
      th { background: #0b1220; color: #93a3b8; }
      form > div { margin: 0.5rem 0; }
      input[type="text"], input[type="number"], textarea, select, input[type="color"] { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid #1e293b; background: #0b1220; color: #e2e8f0; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
      .small { font-size: 0.9rem; color: #93a3b8; }
      .muted { color: #93a3b8; }
      .actions { display: flex; gap: 0.5rem; }
      .hidden { display: none !important; }
      button { background: #4f8cff; color: #fff; border: 0; padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer; }
      button:hover { filter: brightness(1.07); }
      button.secondary { background: #334155; }
      .card { background: linear-gradient(180deg, #0b1220, #0a0f1a); border: 1px solid #1e293b; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); padding: 14px; }
      .preview { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .preview .clock { display: flex; align-items: center; justify-content: center; height: 160px; border-radius: 10px; background: #0a0f1a; border: 1px solid #1e293b; }
      .preview .welcome { display: flex; align-items: center; justify-content: center; height: 64px; border-radius: 10px; background: #0a0f1a; border: 1px solid #1e293b; font-weight: 700; letter-spacing: .5px; white-space: pre-wrap; padding: 0 10px; }
        /* toolbar and picker */
        .toolbar .toolbar-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: end; }
        .picker .picker-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
        /* sub-navigation */
        .subnav { position: sticky; top: 0; z-index: 10; display: flex; flex-wrap: wrap; gap: 8px; padding: 8px 0 10px; background: linear-gradient(180deg, #0b1220, rgba(11,18,32,0.6)); border-bottom: 1px solid #1e293b; margin-bottom: 10px; }
        .subnav a { display: inline-block; padding: 6px 10px; border-radius: 8px; background: #0a0f1a; border: 1px solid #1e293b; color: #cbd5e1; text-decoration: none; font-size: 0.9rem; }
        .subnav a:hover { background: #0c1424; }
        .group { margin-bottom: 12px; }
        @media (max-width: 720px) { .toolbar .toolbar-row { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr; } .preview { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header>
      <h1>Digital Signage Admin</h1>
      <nav class="muted">/admin</nav>
    </header>

    <section class="card toolbar">
      <div class="toolbar-row">
        <div class="picker">
          <label for="screenPicker" class="small">Screen</label>
          <div class="picker-row">
            <select id="screenPicker"><option value="">– Select screen –</option></select>
            <button type="button" id="newScreenBtn" title="Create or start editing a new screen">New</button>
          </div>
          <div class="small">Use the dropdown to quickly switch between screens. Click New to start a new configuration.</div>
        </div>
        <div class="quick-help small">
          <div><b>Tip:</b> Save requires a server API key. Set it at the bottom of the form.</div>
          <div><b>Preview:</b> Live clock and welcome text preview updates as you edit.</div>
        </div>
      </div>
    </section>

    

    <section class="card">
      <h2>Preview</h2>
      <div class="preview">
        <div class="clock" id="clockPreview"></div>
        <div class="welcome" id="welcomePreview">Herzlich Willkommen</div>
      </div>
    </section>

    <section class="card" id="edit">
      <h2>Edit Screen</h2>
      <nav class="subnav">
        <a href="#group-general">General</a>
        <a href="#group-theme">Theme & Layout</a>
        <a href="#group-news">News</a>
        <a href="#group-slideshow">Slideshow</a>
        <a href="#group-clock">Clock</a>
        <a href="#group-web">Web Viewer</a>
        <a href="#group-uploads">Uploads</a>
      </nav>
      <form id="editForm">
        <section id="group-general" class="group">
          <h3>General</h3>
          <div class="row">
          <div>
            <label>Screen ID</label>
            <input id="screenId" type="text" required />
          </div>
          <div>
            <label>Timezone</label>
            <input id="timezone" type="text" placeholder="UTC" />
          </div>
          </div>
          <div class="row">
          <div>
            <label>Weather Location</label>
            <input id="weatherLocation" type="text" placeholder="London" />
          </div>
          <div>
            <label>Web Viewer URL</label>
            <input id="webViewerUrl" type="text" placeholder="https://example.com" />
          </div>
          </div>
        </section>

        <section id="group-theme" class="group">
          <h3>Theme & Layout</h3>
          <div class="row">
          <div>
            <label>Theme</label>
            <select id="theme">
              <option value="dark">dark</option>
              <option value="light">light</option>
            </select>
          </div>
          <div>
            <label>Layout</label>
            <select id="layout">
              <option value="default">default</option>
              <option value="slideshow">slideshow</option>
              <option value="vertical-3">vertical-3</option>
              <option value="news">news</option>
            </select>
          </div>
          </div>
          <div class="row">
          <div>
            <label>Power Profile</label>
            <select id="powerProfile">
              <option value="performance">performance</option>
              <option value="balanced" selected>balanced</option>
              <option value="visual">visual</option>
            </select>
          </div>
          <div class="small">Profiles tune animations and effects:
            <div><b>performance:</b> cut only, short duration, no auto-scroll, minimal effects</div>
            <div><b>balanced:</b> fade/cut, medium duration, light Ken Burns</div>
            <div><b>visual:</b> fade/wipe, longer duration, Ken Burns enabled</div>
          </div>
          </div>
        </section>

        <section id="group-news" class="group">
          <h3>News</h3>
          <div class="row">
          <div>
            <label>News Category (Tagesschau)</label>
            <select id="newsCategory">
              <option value="wirtschaft" selected>wirtschaft</option>
              <option value="top">top</option>
            </select>
          </div>
          <div>
            <label>News Limit</label>
            <input id="newsLimit" type="number" placeholder="8" />
          </div>
          </div>
          <div class="row">
          <div>
            <label>News Rotation (ms)</label>
            <input id="newsRotationMs" type="number" placeholder="8000" />
          </div>
          <div></div>
          </div>
        </section>

        <section id="group-slideshow" class="group">
          <h3>Slideshow</h3>
          <div class="row slideshow-effects">
          <div>
            <label>Slideshow Animations</label>
            <select id="slideshowAnimations" multiple>
              <option value="fade">fade</option>
              <option value="cut">cut</option>
              <option value="wipe">wipe</option>
            </select>
            <div class="small">Hold Ctrl/Cmd to select multiple animations. If multiple are selected, one will be chosen randomly per transition.</div>
          </div>
          <div>
            <label>Animation Duration (ms)</label>
            <input id="slideshowAnimationDurationMs" type="number" placeholder="900" />
            <div style="margin-top:8px">
              <label><input id="slideshowPreloadNext" type="checkbox" /> Preload next image</label>
            </div>
          </div>
          </div>
          <div class="row slideshow-only">
          <div>
            <label>Welcome Text</label>
            <input id="welcomeText" type="text" placeholder="Herzlich Willkommen" />
          </div>
          <div>
            <label>Welcome Text Color</label>
            <input id="welcomeTextColor" type="color" />
            <div class="small">
              <button type="button" id="applyWelcomeColorBtn">Apply color to selected text</button>
            </div>
          </div>
          </div>
          <div class="row slideshow-only">
          <div>
            <label>Bottom Widgets Background Color (slideshow)</label>
            <input id="bottomWidgetsBgColor" type="color" />
          </div>
          <div>
            <label>Bottom Widgets Background Image URL (slideshow)</label>
            <input id="bottomWidgetsBgImage" type="text" placeholder="https://..." />
          </div>
          </div>
        </section>

        <section id="group-clock" class="group">
          <h3>Clock</h3>
          <div class="row">
          <div>
            <label>Clock Type</label>
            <select id="clockType">
              <option value="analog">analog</option>
              <option value="digital">digital</option>
            </select>
          </div>
          <div>
            <label>Clock Style</label>
            <select id="clockStyle">
              <option value="classic">classic</option>
              <option value="mono">mono</option>
              <option value="glass">glass</option>
              <option value="minimal">minimal</option>
              <option value="neon">neon</option>
              <option value="flip">flip</option>
            </select>
          </div>
          </div>
        </section>

        <section id="group-web" class="group">
          <h3>Web Viewer</h3>
          <div class="row">
          <div>
            <label>Web Viewer Mode</label>
            <select id="webViewerMode">
              <option value="iframe">iframe</option>
              <option value="snapshot">snapshot</option>
            </select>
          </div>
          <div>
            <label>Snapshot Refresh (ms)</label>
            <input id="snapshotRefreshMs" type="number" placeholder="300000" />
          </div>
          </div>
          <div class="small" style="margin-top:8px"><b>Auto Scroll</b></div>
          <div class="row">
          <div>
            <label>Auto Scroll</label>
            <select id="autoScrollEnabled">
              <option value="false">disabled</option>
              <option value="true">enabled</option>
            </select>
          </div>
          <div></div>
          </div>
          <div class="row">
          <div>
            <label>Auto Scroll Duration (ms)</label>
            <input id="autoScrollMs" type="number" placeholder="30000" />
          </div>
          <div>
            <label>Auto Scroll Distance (%)</label>
            <input id="autoScrollDistancePct" type="number" placeholder="25" />
          </div>
          </div>
          <div class="row">
          <div>
            <label>Auto Scroll Start Delay (ms)</label>
            <input id="autoScrollStartDelayMs" type="number" placeholder="0" />
          </div>
          <div></div>
          </div>

          <div class="small" style="margin-top:8px"><b>Refresh & Rotation</b></div>
          <div class="row">
          <div>
            <label>Content Refresh (ms)</label>
            <input id="contentMs" type="number" placeholder="30000" />
          </div>
          <div>
            <label>Rotate Interval (ms)</label>
            <input id="rotateMs" type="number" placeholder="8000" />
          </div>
          </div>

          <div class="small" style="margin-top:8px"><b>Content & Schedule</b></div>
          <div>
          <label>Schedule (JSON array)</label>
          <textarea id="schedule" rows="4" placeholder='[]'></textarea>
          </div>
          <div>
          <label>Slides (uploaded image URLs, JSON array)</label>
          <textarea id="slides" rows="3" placeholder='[]'></textarea>
          </div>
        </section>

        <section id="group-uploads" class="group">
          <h3>Uploads & API</h3>
          <div>
          <label>API Key (X-Api-Key)</label>
          <input id="apiKey" type="text" />
          </div>
          <div>
          <label>Upload slides</label>
          <input id="fileInput" type="file" accept="image/*" multiple />
          <button type="button" id="uploadBtn">Upload</button>
          <div class="small">Tip: Select multiple images to add them all at once. Uploaded files are served at /uploads/...</div>
          </div>
        </section>
        <div class="actions">
          <button type="submit">Save</button>
          <button type="button" id="refreshBtn" class="secondary">Force Refresh</button>
        </div>
      </form>
    </section>

    <script>
      const $ = (sel) => document.querySelector(sel);

      function fillForm(cfg, idFromList) {
        $('#screenId').value = cfg.screenId || idFromList || '';
        $('#timezone').value = cfg.timezone || '';
        $('#weatherLocation').value = cfg.weatherLocation || '';
        $('#webViewerUrl').value = cfg.webViewerUrl || '';
        $('#contentMs').value = cfg.refreshIntervals?.contentMs ?? 30000;
        $('#rotateMs').value = cfg.refreshIntervals?.rotateMs ?? 8000;
        $('#webViewerMode').value = cfg.webViewerMode || 'iframe';
        $('#snapshotRefreshMs').value = cfg.snapshotRefreshMs ?? 300000;
        $('#theme').value = cfg.theme || 'dark';
        $('#layout').value = cfg.layout || 'default';
        $('#powerProfile').value = cfg.powerProfile || 'balanced';
        $('#welcomeText').value = cfg.welcomeText || 'Herzlich Willkommen';
        $('#welcomeTextColor').value = cfg.welcomeTextColor || '#ffffff';
        $('#clockType').value = cfg.clockType || 'analog';
        $('#clockStyle').value = cfg.clockStyle || 'classic';
        $('#bottomWidgetsBgColor').value = cfg.bottomWidgetsBgColor || '#000000';
        $('#bottomWidgetsBgImage').value = cfg.bottomWidgetsBgImage || '';
        (function setAnims(){ const el = document.getElementById('slideshowAnimations'); if (!el) return; const vals = (cfg.slideshowAnimations||['fade']).map(String); Array.from(el.options).forEach(o=>o.selected = vals.includes(o.value)); })();
        document.getElementById('slideshowAnimationDurationMs').value = cfg.slideshowAnimationDurationMs ?? 900;
        document.getElementById('slideshowPreloadNext').checked = !!cfg.slideshowPreloadNext;
        document.getElementById('newsCategory').value = cfg.newsCategory || 'wirtschaft';
        document.getElementById('newsLimit').value = cfg.newsLimit ?? 8;
        document.getElementById('newsRotationMs').value = cfg.newsRotationMs ?? 8000;
        $('#autoScrollEnabled').value = String(!!cfg.autoScrollEnabled);
        $('#autoScrollMs').value = cfg.autoScrollMs ?? 30000;
        $('#autoScrollDistancePct').value = cfg.autoScrollDistancePct ?? 25;
        $('#autoScrollStartDelayMs').value = cfg.autoScrollStartDelayMs ?? 0;
        $('#schedule').value = JSON.stringify(cfg.schedule || [], null, 2);
        $('#slides').value = JSON.stringify(cfg.slides || [], null, 2);
        updatePreview();
        toggleSlideshowOnly();
      }

      function populateScreenPicker(screens) {
        const picker = document.getElementById('screenPicker');
        if (!picker) return;
        const cur = picker.value;
        picker.innerHTML = '<option value="">– Select screen –</option>';
        const ids = Object.keys(screens || {}).sort((a,b)=>a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
        ids.forEach(id => {
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = id;
          picker.appendChild(opt);
        });
        if (cur && ids.includes(cur)) picker.value = cur;
      }

      async function loadScreens() {
        const res = await fetch('/api/screens');
        const { screens } = await res.json();
        populateScreenPicker(screens);
      }

      // Screen picker behavior
      document.getElementById('screenPicker')?.addEventListener('change', async (e) => {
        const id = /** @type {HTMLSelectElement} */(e.target).value;
        if (!id) return;
        const cfg = await (await fetch(`/api/config/${encodeURIComponent(id)}`)).json();
        fillForm(cfg, id);
        // Keep the picker in sync with possibly edited screenId
        const pickerEl = document.getElementById('screenPicker');
        if ($('#screenId').value && pickerEl) {
          /** @type {HTMLSelectElement} */ (pickerEl).value = $('#screenId').value;
        }
      });

      document.getElementById('newScreenBtn')?.addEventListener('click', async () => {
        const id = prompt('Enter a new screen ID');
        if (!id) return;
        const cfg = await (await fetch(`/api/config/${encodeURIComponent(id)}`)).json();
        fillForm(cfg, id);
        // update picker list if needed
        try { await loadScreens(); } catch {}
        const picker = /** @type {HTMLSelectElement} */(document.getElementById('screenPicker'));
        if (picker) picker.value = id;
        document.getElementById('screenId')?.focus();
      });

      $('#editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const screenId = $('#screenId').value.trim();
        const payload = {
          screenId,
          timezone: $('#timezone').value.trim() || 'UTC',
          weatherLocation: $('#weatherLocation').value.trim() || 'London',
          webViewerUrl: $('#webViewerUrl').value.trim(),
          refreshIntervals: {
            contentMs: Number($('#contentMs').value) || 30000,
            rotateMs: Number($('#rotateMs').value) || 8000,
          },
          webViewerMode: ($('#webViewerMode').value || 'iframe'),
          snapshotRefreshMs: Number($('#snapshotRefreshMs').value) || 300000,
          theme: ($('#theme').value || 'dark'),
          powerProfile: ($('#powerProfile').value || 'balanced'),
          layout: ($('#layout').value || 'default'),
          welcomeText: $('#welcomeText').value || 'Herzlich Willkommen',
          welcomeTextColor: $('#welcomeTextColor').value || '#ffffff',
          clockType: $('#clockType').value || 'analog',
          clockStyle: $('#clockStyle').value || 'classic',
          bottomWidgetsBgColor: $('#bottomWidgetsBgColor').value || '',
          bottomWidgetsBgImage: $('#bottomWidgetsBgImage').value || '',
          slideshowAnimations: Array.from(document.getElementById('slideshowAnimations')?.selectedOptions || []).map(o=>o.value),
          slideshowAnimationDurationMs: Number(document.getElementById('slideshowAnimationDurationMs')?.value) || 900,
          slideshowPreloadNext: !!document.getElementById('slideshowPreloadNext')?.checked,
          newsCategory: (document.getElementById('newsCategory')?.value || 'wirtschaft'),
          newsLimit: Number(document.getElementById('newsLimit')?.value) || 8,
          newsRotationMs: Number(document.getElementById('newsRotationMs')?.value) || 8000,
          autoScrollEnabled: ($('#autoScrollEnabled').value === 'true'),
          autoScrollMs: Number($('#autoScrollMs').value) || 30000,
          autoScrollDistancePct: Number($('#autoScrollDistancePct').value) || 25,
          autoScrollStartDelayMs: Number($('#autoScrollStartDelayMs').value) || 0,
          schedule: JSON.parse($('#schedule').value || '[]'),
          slides: JSON.parse($('#slides').value || '[]'),
        };
        const apiKey = $('#apiKey').value.trim();
        const res = await fetch(`/api/config/${encodeURIComponent(screenId)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(apiKey ? { 'X-Api-Key': apiKey } : {}),
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert('Failed to save: ' + res.status);
          return;
        }
        await loadScreens();
        alert('Saved');
      });

      // Upload handler
      $('#uploadBtn').addEventListener('click', async () => {
        const files = Array.from($('#fileInput').files || [])
        if (!files.length) return alert('Choose at least one image')
        const apiKey = $('#apiKey').value.trim();
        const uploaded = []
        try {
          $('#uploadBtn').disabled = true
          for (const f of files) {
            const fd = new FormData()
            fd.append('file', f)
            const res = await fetch('/api/uploads', { method: 'POST', headers: apiKey ? { 'X-Api-Key': apiKey } : {}, body: fd })
            if (!res.ok) throw new Error('Upload failed: ' + res.status)
            const { url } = await res.json()
            uploaded.push(url)
          }
          const arr = JSON.parse($('#slides').value || '[]')
          uploaded.forEach((u) => arr.push(u))
          $('#slides').value = JSON.stringify(arr, null, 2)
          alert('Uploaded ' + uploaded.length + ' file(s)')
        } catch (err) {
          alert(String(err?.message || err || 'Upload failed'))
        } finally {
          $('#uploadBtn').disabled = false
          $('#fileInput').value = ''
        }
      })

      $('#refreshBtn').addEventListener('click', async () => {
        const id = $('#screenId').value.trim();
        if (!id) return alert('Set Screen ID first');
        const apiKey = $('#apiKey').value.trim();
        const res = await fetch(`/api/push/${encodeURIComponent(id)}/refresh`, {
          method: 'POST',
          headers: apiKey ? { 'X-Api-Key': apiKey } : {},
        });
        if (!res.ok) return alert('Failed to push refresh');
        alert('Refresh pushed');
      });

      // Apply inline color to selected part of Welcome Text
      $('#applyWelcomeColorBtn').addEventListener('click', () => {
        const input = /** @type {HTMLInputElement} */ (document.getElementById('welcomeText'))
        const color = /** @type {HTMLInputElement} */ (document.getElementById('welcomeTextColor'))
        if (!input || !color) return
        const val = input.value || ''
        const start = input.selectionStart ?? 0
        const end = input.selectionEnd ?? 0
        if (start === end) { alert('Select the part of the text you want to color first.'); return }
        const sel = val.slice(start, end)
        const c = (color.value || '#ffffff').trim()
        const before = val.slice(0, start)
        const after = val.slice(end)
        const tag = `{#${c.replace(/^#/, '')}}${sel}{/}`
        const next = before + tag + after
        input.value = next
        // Restore focus and selection around the colored segment
        input.focus()
        const newStart = before.length
        const newEnd = newStart + tag.length
        try { input.setSelectionRange(newStart, newEnd) } catch {}
      })

      // Live preview
      function clockPreviewAnalog(style, theme) {
        const box = document.getElementById('clockPreview');
        if (!box) return; box.innerHTML = '';
        const size = 140; const r = size/2; const ring = r - 10;
        const svgNS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('viewBox', `0 0 ${size} ${size}`); svg.style.width = '160px'; svg.style.height = '160px';
        const isLight = theme === 'light';
        let bg = isLight ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.35)';
        let tick = isLight ? '#444' : '#666';
        let hour = isLight ? '#222' : '#fff';
        let minute = isLight ? '#444' : '#ddd';
        let second = isLight ? '#e33' : '#ff4d4d';
        if (style === 'mono') { const ink = isLight ? '#222' : '#fff'; bg = isLight ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.35)'; tick=hour=minute=second=ink; }
        if (style === 'glass') { bg = isLight ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.25)'; tick = isLight ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.6)'; hour = isLight ? '#333' : '#fff'; minute = isLight ? '#555' : '#ddd'; second = isLight ? '#e33' : '#ff5757'; }
        const circle = document.createElementNS(svgNS, 'circle'); circle.setAttribute('cx', String(r)); circle.setAttribute('cy', String(r)); circle.setAttribute('r', String(r)); circle.setAttribute('fill', bg); circle.setAttribute('stroke', 'rgba(0,0,0,0.4)'); circle.setAttribute('stroke-width','2'); svg.appendChild(circle);
        for (let i=0;i<60;i++){ const len = i%5===0?10:5; const line = document.createElementNS(svgNS,'line'); const a=i*Math.PI/30; const x1=r+Math.sin(a)*(ring-len); const y1=r-Math.cos(a)*(ring-len); const x2=r+Math.sin(a)*ring; const y2=r-Math.cos(a)*ring; line.setAttribute('x1',x1.toFixed(1)); line.setAttribute('y1',y1.toFixed(1)); line.setAttribute('x2',x2.toFixed(1)); line.setAttribute('y2',y2.toFixed(1)); line.setAttribute('stroke',tick); line.setAttribute('stroke-width', i%5===0?'3':'2'); svg.appendChild(line);}        
        const hourHand = document.createElementNS(svgNS,'line'); const minuteHand = document.createElementNS(svgNS,'line'); const secondHand = document.createElementNS(svgNS,'line');
        [hourHand,minuteHand,secondHand].forEach((l)=>{ l.setAttribute('x1',String(r)); l.setAttribute('y1',String(r)); l.setAttribute('stroke-linecap','round'); })
        hourHand.setAttribute('stroke',hour); hourHand.setAttribute('stroke-width','6');
        minuteHand.setAttribute('stroke',minute); minuteHand.setAttribute('stroke-width','4');
        secondHand.setAttribute('stroke',second); secondHand.setAttribute('stroke-width','2');
        svg.appendChild(hourHand); svg.appendChild(minuteHand); svg.appendChild(secondHand);
        const tickFn = ()=>{ const d=new Date(); const h=d.getHours()%12; const m=d.getMinutes(); const s=d.getSeconds(); const sDeg=s/60*360; const mDeg=(m+s/60)/60*360; const hDeg=(h+m/60)/12*360; const set=(el,deg,len)=>{ const rad=(deg-90)*Math.PI/180; const x=r+Math.cos(rad)*(ring*len); const y=r+Math.sin(rad)*(ring*len); el.setAttribute('x2',String(x)); el.setAttribute('y2',String(y)); }; set(hourHand,hDeg,0.55); set(minuteHand,mDeg,0.78); set(secondHand,sDeg,0.9); };
        tickFn(); setInterval(tickFn, 500);
        box.appendChild(svg);
      }

      function clockPreviewDigital(style) {
        const box = document.getElementById('clockPreview'); if (!box) return; box.innerHTML='';
        const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.justifyContent='center'; wrap.style.height='100%';
        const timeStr = ()=> new Intl.DateTimeFormat('de-DE',{ hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(new Date());
        if (style==='neon') { const el = document.createElement('div'); el.style.fontFamily='monospace'; el.style.fontWeight='700'; el.style.fontSize='48px'; el.style.color='#00e5ff'; el.style.textShadow='0 0 8px #00e5ff80, 0 0 16px #00e5ff80'; el.textContent=timeStr(); wrap.appendChild(el); setInterval(()=> el.textContent=timeStr(), 500); }
        else if (style==='flip') { const root=document.createElement('div'); root.style.display='flex'; root.style.alignItems='center'; const mk=(t)=>{ const d=document.createElement('div'); d.style.background='#111'; d.style.color='#fff'; d.style.borderRadius='6px'; d.style.padding='6px 10px'; d.style.margin='0 4px'; d.style.fontFamily='monospace'; d.style.fontSize='40px'; d.style.boxShadow='0 2px 8px rgba(0,0,0,0.4)'; d.textContent=t; return d; }; const update=()=>{ const now=new Date(); const f=new Intl.DateTimeFormat('de-DE',{ hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(now); const [h,m,s]=f.split(':'); root.innerHTML=''; root.appendChild(mk(h)); root.appendChild(document.createTextNode(':')); root.appendChild(mk(m)); root.appendChild(document.createTextNode(':')); root.appendChild(mk(s)); }; update(); setInterval(update,500); wrap.appendChild(root); }
        else { const el=document.createElement('div'); el.style.fontFamily='ui-rounded, SF Pro Rounded, Segoe UI, Roboto, system-ui'; el.style.fontWeight='700'; el.style.fontSize='44px'; el.style.color='#fff'; el.style.letterSpacing='1px'; el.textContent=timeStr(); wrap.appendChild(el); setInterval(()=> el.textContent=timeStr(), 500) }
        box.appendChild(wrap);
      }

      function renderColoredText(raw, defaultColor) {
        const container = document.createElement('span');
        const pattern = /\{#([0-9a-fA-F]{3,8}|[a-zA-Z]+)\}([\s\S]*?)\{\/\}/g;
        let lastIndex = 0; let m;
        while ((m = pattern.exec(raw))) {
          const [full, color, text] = m;
          if (m.index > lastIndex) container.appendChild(document.createTextNode(raw.slice(lastIndex, m.index)));
          const span = document.createElement('span');
          const c = color.startsWith('#') ? color : (/^[a-zA-Z]+$/.test(color) ? color : ('#' + color));
          span.style.color = c; span.textContent = text; container.appendChild(span);
          lastIndex = m.index + full.length;
        }
        if (lastIndex < raw.length) container.appendChild(document.createTextNode(raw.slice(lastIndex)));
        if (!container.childNodes.length) { const s=document.createElement('span'); s.style.color=defaultColor; s.textContent=raw; container.appendChild(s) }
        return container;
      }

      function updatePreview() {
        const type = document.getElementById('clockType')?.value || 'analog';
        const style = document.getElementById('clockStyle')?.value || (type==='digital' ? 'minimal' : 'classic');
        const theme = document.getElementById('theme')?.value || 'dark';
        const welcome = document.getElementById('welcomeText')?.value || 'Herzlich Willkommen';
        const color = (document.getElementById('welcomeTextColor')?.value || '#ffffff');
        const bgCol = (document.getElementById('bottomWidgetsBgColor')?.value || '');
        const bgImg = (document.getElementById('bottomWidgetsBgImage')?.value || '');
        if (type==='digital') clockPreviewDigital(style);
        else clockPreviewAnalog(style, theme);
        const wp = document.getElementById('welcomePreview');
        if (wp) {
          wp.innerHTML = '';
          const colored = renderColoredText(welcome, color); wp.appendChild(colored);
          wp.style.backgroundImage = bgImg ? `url(${bgImg})` : '';
          wp.style.backgroundSize = 'cover'; wp.style.backgroundPosition = 'center'; wp.style.backgroundRepeat = 'no-repeat';
          wp.style.backgroundColor = bgCol || '#0a0f1a';
        }
        const cp = document.getElementById('clockPreview');
        if (cp) {
          cp.style.backgroundImage = bgImg ? `url(${bgImg})` : '';
          cp.style.backgroundSize = 'cover'; cp.style.backgroundPosition = 'center'; cp.style.backgroundRepeat = 'no-repeat';
          cp.style.backgroundColor = bgCol || '#0a0f1a';
        }
      }

      ['clockType','clockStyle','theme','welcomeText','welcomeTextColor','bottomWidgetsBgColor','bottomWidgetsBgImage'].forEach((id)=>{
        const el = document.getElementById(id); if (el) el.addEventListener('input', updatePreview)
      })
      document.getElementById('layout')?.addEventListener('change', () => { toggleSlideshowOnly(); updatePreview(); })

      function toggleSlideshowOnly() {
        const layoutVal = (document.getElementById('layout')?.value || 'default')
        const isShow = layoutVal === 'slideshow'
        // Effects apply to both slideshow and news (as both use slideshow component)
        const showEffects = layoutVal === 'slideshow' || layoutVal === 'news'
        document.querySelectorAll('.slideshow-only').forEach((el) => {
          el.classList.toggle('hidden', !isShow)
        })
        document.querySelectorAll('.slideshow-effects').forEach((el) => {
          el.classList.toggle('hidden', !showEffects)
        })
      }

      // Initial preview + toggle
      updatePreview();
      toggleSlideshowOnly();

      loadScreens();
      document.getElementById('bottomBgUploadBtn')?.addEventListener('click', async () => {
        const fileInput = /** @type {HTMLInputElement} */ (document.getElementById('bottomBgFile'))
        const f = fileInput?.files?.[0]
        if (!f) return alert('Choose an image first')
        const apiKey = document.getElementById('apiKey')?.value?.trim() || ''
        const fd = new FormData(); fd.append('file', f)
        const res = await fetch('/api/uploads', { method: 'POST', headers: apiKey ? { 'X-Api-Key': apiKey } : {}, body: fd })
        if (!res.ok) return alert('Upload failed')
        const { url } = await res.json()
        const urlInput = /** @type {HTMLInputElement} */ (document.getElementById('bottomWidgetsBgImage'))
        urlInput.value = url
        fileInput.value = ''
        updatePreview()
      })
    </script>
  </body>
  </html>


