<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Digital Signage Admin</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 1rem auto; max-width: 1000px; padding: 0 1rem; background: #0f172a; color: #e2e8f0; }
      header { display: flex; align-items: center; justify-content: space-between; }
      .header-right { display: flex; align-items: center; gap: 8px; }
      #langPicker { background: #0b1220; color: #e2e8f0; border: 1px solid #1e293b; border-radius: 8px; padding: 6px 10px; }
      h1 { margin: 0.5rem 0; }
      h2 { margin: 1rem 0 0.5rem; }
        h3 { margin: 0.75rem 0 0.5rem; font-size: 1.05rem; color: #cbd5e1; }
      table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { border: 1px solid #1e293b; padding: 0.5rem; text-align: left; }
      th { background: #0b1220; color: #93a3b8; }
      form > div { margin: 0.5rem 0; }
      input[type="text"], input[type="number"], textarea, select, input[type="color"] { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid #1e293b; background: #0b1220; color: #e2e8f0; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
      .small { font-size: 0.9rem; color: #93a3b8; }
      .muted { color: #93a3b8; }
      .actions { display: flex; gap: 0.5rem; }
      .hidden { display: none !important; }
      button { background: #4f8cff; color: #fff; border: 0; padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer; }
      button:hover { filter: brightness(1.07); }
      button.secondary { background: #334155; }
      .card { background: linear-gradient(180deg, #0b1220, #0a0f1a); border: 1px solid #1e293b; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); padding: 14px; }
      .preview { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .preview .clock { display: flex; align-items: center; justify-content: center; height: 160px; border-radius: 10px; background: #0a0f1a; border: 1px solid #1e293b; }
      .preview .welcome { display: flex; align-items: center; justify-content: center; height: 64px; border-radius: 10px; background: #0a0f1a; border: 1px solid #1e293b; font-weight: 700; letter-spacing: .5px; white-space: pre-wrap; padding: 0 10px; }
        /* toolbar and picker */
        .toolbar .toolbar-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: end; }
        .picker .picker-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
        /* tabs and save controls */
        .save-controls .save-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
        .save-controls .actions { display: inline-flex; gap: 8px; }
        .tabs { position: sticky; top: 0; z-index: 10; display: flex; flex-wrap: wrap; gap: 8px; padding: 8px 0 10px; background: linear-gradient(180deg, #0b1220, rgba(11,18,32,0.6)); border-bottom: 1px solid #1e293b; margin-bottom: 10px; }
        .tab { background: #0a0f1a; border: 1px solid #1e293b; color: #cbd5e1; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
        .tab:hover { background: #0c1424; }
        .tab.tab-active { background: #1b2a4a; border-color: #334155; color: #fff; }
        .tab-panel.hidden { display: none; }
        .group { margin-bottom: 12px; }
        .player-preview { display: grid; gap: 8px; }
        .player-preview .ratio-16x9-box { position: relative; width: 100%; max-width: 960px; aspect-ratio: 16 / 9; background: #000; border: 1px solid #1e293b; border-radius: 10px; overflow: hidden; margin: 0 auto; }
        .player-preview .ratio-16x9-box iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; background: #000; }
        @media (max-width: 720px) { .toolbar .toolbar-row { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr; } .preview { grid-template-columns: 1fr; } }
        @media (max-width: 992px) { #previewCard { display: none; } }
    </style>
  </head>
  <body>
    <header>
      <h1 class="i18n" data-i18n="title">Digital Signage Admin</h1>
      <div class="header-right">
      <nav class="muted">/admin</nav>
        <select id="langPicker" title="Sprache">
          <option value="de" selected>Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>
    </header>

    <section class="card toolbar">
      <div class="toolbar-row">
        <div class="picker">
          <label for="screenPicker" class="small i18n" data-i18n="toolbar.screen">Bildschirm</label>
          <div class="picker-row">
            <select id="screenPicker"><option value="">– Select screen –</option></select>
            <button type="button" id="newScreenBtn" class="i18n" data-i18n="btn.new" title="Neuen Bildschirm anlegen">Neu</button>
          </div>
          <div class="small i18n" data-i18n="hint.useDropdown">Nutzen Sie die Auswahl, um schnell zwischen Bildschirmen zu wechseln.</div>
        </div>
        <div class="save-controls">
          <label class="small i18n" data-i18n="save.apiKey" for="apiKeyTop">API-Schlüssel (X-Api-Key)</label>
          <div class="save-row">
            <input id="apiKeyTop" type="text" placeholder="Ihr API-Schlüssel" data-i18n-placeholder="ph.apiKey" />
            <div class="actions">
              <button type="submit" form="editForm" class="i18n" data-i18n="btn.save">Speichern</button>
              <button type="button" id="refreshBtnTop" class="secondary i18n" data-i18n="btn.refresh">Neu laden</button>
            </div>
          </div>
          <div class="small i18n" data-i18n="hint.saveAnywhere">Von jedem Tab speichern. "Neu laden" lädt den ausgewählten Bildschirm neu.</div>
        </div>
      </div>
    </section>

    

    <section class="card" id="previewCard">
      <h2 class="i18n" data-i18n="heading.preview">Vorschau</h2>
      <div class="player-preview">
        <div class="ratio-16x9-box">
          <iframe id="playerPreview" title="Player Preview" src="" allowfullscreen></iframe>
        </div>
        <div class="small i18n" data-i18n="hint.previewNote" style="margin-top:6px">Die Vorschau lädt /player/{Screen ID} in einem kleinen Fenster. Für Live-Änderungen bitte speichern und ggf. neu laden.</div>
      </div>
    </section>

    <section class="card" id="edit">
      <h2 class="i18n" data-i18n="heading.edit">Bildschirm bearbeiten</h2>
      <div class="tabs" role="tablist">
        <button class="tab tab-active i18n" data-i18n="tab.general" data-tab="group-general" role="tab" aria-selected="true">Allgemein</button>
        <button class="tab i18n" data-i18n="tab.theme" data-tab="group-theme" role="tab">Thema & Layout</button>
        <button class="tab i18n" data-i18n="tab.news" data-tab="group-news" role="tab">Nachrichten</button>
        <button class="tab i18n" data-i18n="tab.slideshow" data-tab="group-slideshow" role="tab">Slideshow</button>
        <button class="tab i18n" data-i18n="tab.web" data-tab="group-web" role="tab">Web Viewer</button>
        <button class="tab i18n" data-i18n="tab.uploads" data-tab="group-uploads" role="tab">Uploads</button>
      </div>
      <form id="editForm">
        <section id="group-general" class="group tab-panel">
          <h3 class="i18n" data-i18n="group.general">Allgemein</h3>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.screenId">Screen ID</label>
            <input id="screenId" type="text" required />
          </div>
          <div>
            <label class="i18n" data-i18n="field.timezone">Zeitzone</label>
            <input id="timezone" type="text" placeholder="UTC" />
          </div>
        </div>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.weatherLocation">Wetter-Ort</label>
            <input id="weatherLocation" type="text" placeholder="London" />
          </div>
          <div>
            <label>Web Viewer URL</label>
            <input id="webViewerUrl" type="text" placeholder="https://example.com" />
          </div>
        </div>
        </section>

        <section id="group-theme" class="group tab-panel hidden">
          <h3 class="i18n" data-i18n="group.theme">Thema & Layout</h3>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.theme">Thema</label>
            <select id="theme">
              <option value="dark" class="i18n" data-i18n="opt.dark">dunkel</option>
              <option value="light" class="i18n" data-i18n="opt.light">hell</option>
            </select>
          </div>
          <div>
            <label class="i18n" data-i18n="field.layout">Layout</label>
            <select id="layout">
              <option value="default" class="i18n" data-i18n="opt.layout.default">Standard</option>
              <option value="slideshow" class="i18n" data-i18n="opt.layout.slideshow">Slideshow</option>
              <option value="vertical-3" class="i18n" data-i18n="opt.layout.vertical3">Vertikal 3</option>
              <option value="news" class="i18n" data-i18n="opt.layout.news">News</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.powerProfile">Leistungsprofil</label>
            <select id="powerProfile">
              <option value="performance" class="i18n" data-i18n="opt.profile.performance">Leistung</option>
              <option value="balanced" selected class="i18n" data-i18n="opt.profile.balanced">Ausgewogen</option>
              <option value="visual" class="i18n" data-i18n="opt.profile.visual">Visuell</option>
            </select>
          </div>
          <div class="small i18n" data-i18n-html="hint.profile"></div>
        </div>
          <div class="row">
          <div>
            <label class="i18n" data-i18n="field.clockType">Uhrtyp</label>
            <select id="clockType">
              <option value="analog" class="i18n" data-i18n="opt.clock.analog">Analog</option>
              <option value="digital" class="i18n" data-i18n="opt.clock.digital">Digital</option>
            </select>
          </div>
          <div>
            <label class="i18n" data-i18n="field.clockStyle">Uhrstil</label>
            <select id="clockStyle">
              <option value="classic" class="i18n" data-i18n="opt.clock.classic">Classic</option>
              <option value="mono" class="i18n" data-i18n="opt.clock.mono">Mono</option>
              <option value="glass" class="i18n" data-i18n="opt.clock.glass">Glass</option>
              <option value="minimal" class="i18n" data-i18n="opt.clock.minimal">Minimal</option>
              <option value="neon" class="i18n" data-i18n="opt.clock.neon">Neon</option>
              <option value="flip" class="i18n" data-i18n="opt.clock.flip">Flip</option>
            </select>
          </div>
        </div>
        </section>

        <section id="group-news" class="group tab-panel hidden">
          <h3 class="i18n" data-i18n="group.news">Nachrichten</h3>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.newsCategory">Kategorie (Tagesschau)</label>
            <select id="newsCategory">
              <option value="wirtschaft" selected class="i18n" data-i18n="opt.news.wirtschaft">Wirtschaft</option>
              <option value="top" class="i18n" data-i18n="opt.news.top">Top</option>
            </select>
          </div>
          <div>
            <label class="i18n" data-i18n="field.newsLimit">Anzahl</label>
            <input id="newsLimit" type="number" placeholder="8" />
          </div>
        </div>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.newsRotationMs">Dauer pro Meldung (ms)</label>
            <input id="newsRotationMs" type="number" placeholder="8000" />
          </div>
          <div></div>
        </div>
        </section>

        <section id="group-slideshow" class="group tab-panel hidden">
          <h3 class="i18n" data-i18n="group.slideshow">Slideshow</h3>
        <div class="row slideshow-effects">
          <div>
            <label class="i18n" data-i18n="field.slideshowAnimations">Slideshow-Animationen</label>
            <select id="slideshowAnimations" multiple>
              <option value="fade">fade</option>
              <option value="cut">cut</option>
              <option value="wipe">wipe</option>
            </select>
            <div class="small i18n" data-i18n="hint.slideshowAnims">Tipp: Mit Strg/Cmd mehrere Animationen auswählen. Wenn mehrere gewählt sind, wird pro Übergang zufällig eine verwendet.</div>
          </div>
          <div>
            <label class="i18n" data-i18n="field.animationDuration">Animationsdauer (ms)</label>
            <input id="slideshowAnimationDurationMs" type="number" placeholder="900" />
            <div style="margin-top:8px">
              <label><input id="slideshowPreloadNext" type="checkbox" /> Preload next image</label>
            </div>
          </div>
        </div>
        <div class="row slideshow-only">
          <div>
            <label>Welcome Text</label>
            <input id="welcomeText" type="text" placeholder="Herzlich Willkommen" />
          </div>
          <div>
            <label>Welcome Text Color</label>
            <input id="welcomeTextColor" type="color" />
            <div class="small">
              <button type="button" id="applyWelcomeColorBtn">Apply color to selected text</button>
            </div>
          </div>
        </div>
        <div class="row slideshow-only">
          <div>
            <label>Bottom Widgets Background Color (slideshow)</label>
            <input id="bottomWidgetsBgColor" type="color" />
          </div>
          <div>
            <label>Bottom Widgets Background Image URL (slideshow)</label>
            <input id="bottomWidgetsBgImage" type="text" placeholder="https://..." />
          </div>
        </div>
        </section>


        <section id="group-web" class="group tab-panel hidden">
           <h3 class="i18n" data-i18n="group.web">Web Viewer</h3>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.webMode">Web Viewer Modus</label>
            <select id="webViewerMode">
              <option value="iframe" class="i18n" data-i18n="opt.web.iframe">Iframe</option>
              <option value="snapshot" class="i18n" data-i18n="opt.web.snapshot">Snapshot</option>
            </select>
          </div>
          <div>
            <label class="i18n" data-i18n="field.snapshotRefreshMs">Snapshot-Aktualisierung (ms)</label>
            <input id="snapshotRefreshMs" type="number" placeholder="300000" />
          </div>
        </div>
           <div class="small i18n" data-i18n="group.autoScroll" style="margin-top:8px"><b>Auto Scroll</b></div>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.autoScrollEnabled">Auto Scroll</label>
            <select id="autoScrollEnabled">
              <option value="false" class="i18n" data-i18n="opt.no">Aus</option>
              <option value="true" class="i18n" data-i18n="opt.yes">An</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.autoScrollMs">Auto Scroll Dauer (ms)</label>
            <input id="autoScrollMs" type="number" placeholder="30000" />
          </div>
          <div>
            <label class="i18n" data-i18n="field.autoScrollDistance">Auto Scroll Distanz (%)</label>
            <input id="autoScrollDistancePct" type="number" placeholder="25" />
          </div>
        </div>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.autoScrollStartDelay">Auto Scroll Startverzögerung (ms)</label>
            <input id="autoScrollStartDelayMs" type="number" placeholder="0" />
          </div>
          <div></div>
        </div>

           <div class="small i18n" data-i18n="group.refresh" style="margin-top:8px"><b>Aktualisierung & Rotation</b></div>
        <div class="row">
          <div>
            <label class="i18n" data-i18n="field.contentMs">Inhalt-Aktualisierung (ms)</label>
            <input id="contentMs" type="number" placeholder="30000" />
          </div>
          <div>
            <label class="i18n" data-i18n="field.rotateMs">Wechselintervall (ms)</label>
            <input id="rotateMs" type="number" placeholder="8000" />
          </div>
        </div>

           <div class="small i18n" data-i18n="group.content" style="margin-top:8px"><b>Inhalt & Zeitplan</b></div>
        <div>
           <label class="i18n" data-i18n="field.schedule">Zeitplan (JSON Array)</label>
             <div class="small i18n" data-i18n="desc.schedule">Zeitbasierte Regeln, die Felder des Bildschirms zu bestimmten Zeiten/Tagen überschreiben.</div>
             <div class="small i18n" data-i18n="heading.example" style="margin-top:6px"><b>Beispiel</b></div>
             <pre class="i18n" data-i18n="example.schedule" style="background:#0b1220;border:1px solid #1e293b;border-radius:8px;padding:8px;white-space:pre-wrap;word-break:break-word;overflow:auto"></pre>
          <textarea id="schedule" rows="4" placeholder='[]'></textarea>
        </div>
        </section>

        <section id="group-uploads" class="group tab-panel hidden">
          <h3 class="i18n" data-i18n="group.uploads">Uploads</h3>
          <div class="small i18n" data-i18n="hint.uploadsSlidesRef">Slides werden hier verwaltet. Hochgeladene Bilder werden der Liste automatisch hinzugefügt.</div>
        <div>
            <label class="i18n" data-i18n="field.slides">Slides (Bild-URLs, JSON Array)</label>
          <textarea id="slides" rows="3" placeholder='[]'></textarea>
        </div>
        <div>
          <label class="i18n" data-i18n="field.uploadSlides">Slides hochladen</label>
          <input id="fileInput" type="file" accept="image/*" multiple />
          <button type="button" id="uploadBtn" class="i18n" data-i18n="btn.upload">Hochladen</button>
          <div class="small i18n" data-i18n="hint.upload">Tipp: Mehrere Bilder auswählen, um alle auf einmal hinzuzufügen. Dateien werden unter /uploads/... bereitgestellt.</div>
        </div>
        </section>
        <div class="actions">
          <button type="submit" class="i18n" data-i18n="btn.save">Speichern</button>
          <button type="button" id="refreshBtn" class="secondary i18n" data-i18n="btn.refresh">Neu laden</button>
          <div class="small i18n" data-i18n="hint.saveForm">Zum Speichern ist ein gültiger API-Schlüssel erforderlich.</div>
        </div>
      </form>
    </section>

    <script>
      const $ = (sel) => document.querySelector(sel);

      // Simple i18n store (de default)
      const I18N = {
        de: {
          title: 'Digital Signage Admin',
          'toolbar.screen': 'Bildschirm',
          'btn.new': 'Neu',
          'hint.useDropdown': 'Nutzen Sie die Auswahl, um schnell zwischen Bildschirmen zu wechseln.',
          'save.apiKey': 'API-Schlüssel (X-Api-Key)',
          'ph.apiKey': 'Ihr API-Schlüssel',
          'btn.save': 'Speichern',
          'btn.refresh': 'Neu laden',
          'hint.saveAnywhere': 'Von jedem Tab speichern. "Neu laden" lädt den ausgewählten Bildschirm neu.',
          'tab.general': 'Allgemein',
          'tab.theme': 'Thema & Layout',
          'tab.news': 'Nachrichten',
          'tab.slideshow': 'Slideshow',
          'tab.web': 'Web Viewer',
          'tab.uploads': 'Uploads',
          'group.general': 'Allgemein',
          'group.theme': 'Thema & Layout',
          'group.news': 'Nachrichten',
          'group.slideshow': 'Slideshow',
          'group.web': 'Web Viewer',
          'group.uploads': 'Uploads',
          'field.screenId': 'Screen ID',
          'field.timezone': 'Zeitzone',
          'field.weatherLocation': 'Wetter-Ort',
          'field.theme': 'Thema',
          'opt.dark': 'dunkel',
          'opt.light': 'hell',
          'field.layout': 'Layout',
          'opt.layout.default': 'Standard',
          'opt.layout.slideshow': 'Slideshow',
          'opt.layout.vertical3': 'Vertikal 3',
          'opt.layout.news': 'News',
          'field.powerProfile': 'Leistungsprofil',
          'opt.profile.performance': 'Leistung',
          'opt.profile.balanced': 'Ausgewogen',
          'opt.profile.visual': 'Visuell',
          'hint.profile': 'Profile passen Animationen und Effekte an:<br/>' +
            '<div><b>Leistung:</b> nur Schnitt, kurze Dauer, kein Auto-Scroll, minimale Effekte</div>' +
            '<div><b>Ausgewogen:</b> Fade/Schnitt, mittlere Dauer, leichter Ken Burns</div>' +
            '<div><b>Visuell:</b> Fade/Wipe, längere Dauer, Ken Burns aktiviert</div>',
          'desc.theme': 'Wähle ein helles oder dunkles Erscheinungsbild für die Admin-Oberfläche und Player-Widgets.',
          'desc.layout': 'Steuert die Anordnung der Module auf dem Bildschirm.',
          'desc.powerProfile': 'Optimiert Animationen/Effekte je nach Leistungsziel.',
          'desc.clock': 'Stil der Uhr, die im Player angezeigt wird.',
          'desc.welcome': 'Text und Farbe der Begrüßungszeile in Slideshow-Layouts.',
          'desc.news': 'Tagesschau-Quelle, Anzahl und Wechseldauer der Meldungen.',
          'desc.slideshow': 'Übergangseffekte und Dauer zwischen Bildern.',
          'desc.web': 'Eingebettete Website oder Snapshot, inkl. Auto-Scroll und Aktualisierungsintervalle.',
          'desc.uploads': 'Verwalte hochgeladene Bilder und füge sie den Slides hinzu.',
          'field.clockType': 'Uhrtyp',
          'opt.clock.analog': 'Analog',
          'opt.clock.digital': 'Digital',
          'field.clockStyle': 'Uhrstil',
          'opt.clock.classic': 'Classic',
          'opt.clock.mono': 'Mono',
          'opt.clock.glass': 'Glass',
          'opt.clock.minimal': 'Minimal',
          'opt.clock.neon': 'Neon',
          'opt.clock.flip': 'Flip',
          'field.welcomeText': 'Begrüßungstext',
          'field.welcomeColor': 'Textfarbe',
          'btn.applyColor': 'Farbe auf markierten Text anwenden',
          'field.bottomBgColor': 'Hintergrundfarbe (Slideshow)',
          'field.bottomBgImage': 'Hintergrundbild URL (Slideshow)',
          'field.newsCategory': 'Kategorie (Tagesschau)',
          'opt.news.wirtschaft': 'Wirtschaft',
          'opt.news.top': 'Top',
          'field.newsLimit': 'Anzahl',
          'field.newsRotationMs': 'Dauer pro Meldung (ms)',
          'field.slideshowAnimations': 'Slideshow-Animationen',
          'field.animationDuration': 'Animationsdauer (ms)',
          'group.autoScroll': 'Auto Scroll',
          'field.webUrl': 'Web Viewer URL',
          'field.webMode': 'Web Viewer Modus',
          'opt.web.iframe': 'Iframe',
          'opt.web.snapshot': 'Snapshot',
          'field.snapshotRefreshMs': 'Snapshot-Aktualisierung (ms)',
          'field.autoScrollEnabled': 'Auto Scroll',
          'opt.no': 'Aus',
          'opt.yes': 'An',
          'field.autoScrollMs': 'Auto Scroll Dauer (ms)',
          'field.autoScrollDistance': 'Auto Scroll Distanz (%)',
          'field.autoScrollStartDelay': 'Auto Scroll Startverzögerung (ms)',
          'group.refresh': 'Aktualisierung & Rotation',
          'field.contentMs': 'Inhalt-Aktualisierung (ms)',
          'field.rotateMs': 'Wechselintervall (ms)',
          'group.content': 'Inhalt & Zeitplan',
          'field.schedule': 'Zeitplan (JSON Array)',
          'desc.schedule': 'Zeitbasierte Regeln, die Felder des Bildschirms zu bestimmten Zeiten/Tagen überschreiben. Nutze kurzgeschriebene Wochentage: mon, tue, wed, thu, fri, sat, sun (auch mo, di, mi, do, fr, sa, so). Start/Ende im 24h-Format HH:MM. Bei Ende < Start wird über Mitternacht gezählt. Erste passende Regel (von oben) gewinnt.',
          'heading.example': 'Beispiel',
          'example.schedule': '[\n  {\n    "days": ["mon","tue","wed","thu","fri"],\n    "start": "08:00",\n    "end": "12:00",\n    "overrides": {\n      "layout": "news",\n      "theme": "light",\n      "newsRotationMs": 6000\n    }\n  },\n  {\n    "days": ["sat","sun"],\n    "start": "00:00",\n    "end": "24:00",\n    "overrides": {\n      "layout": "slideshow",\n      "powerProfile": "visual",\n      "slideshowAnimations": ["fade","wipe"],\n      "slideshowAnimationDurationMs": 1200\n    }\n  }\n]',
          'field.slides': 'Slides (Bild-URLs, JSON Array)',
          'field.uploadSlides': 'Slides hochladen',
          'btn.upload': 'Hochladen',
          'hint.upload': 'Tipp: Mehrere Bilder auswählen, um alle auf einmal hinzuzufügen. Dateien werden unter /uploads/... bereitgestellt.',
          'heading.preview': 'Vorschau',
          'hint.previewNote': 'Die Vorschau lädt /player/{Screen ID} in einem kleinen Fenster. Für Live-Änderungen bitte speichern und ggf. neu laden.',
          'heading.edit': 'Bildschirm bearbeiten',
          'hint.slideshowAnims': 'Tipp: Mit Strg/Cmd mehrere Animationen auswählen. Wenn mehrere gewählt sind, wird pro Übergang zufällig eine verwendet.',
          'hint.saveForm': 'Zum Speichern ist ein gültiger API-Schlüssel erforderlich.',
        },
        en: {
          title: 'Digital Signage Admin',
          'toolbar.screen': 'Screen',
          'btn.new': 'New',
          'hint.useDropdown': 'Use the dropdown to quickly switch between screens.',
          'save.apiKey': 'API Key (X-Api-Key)',
          'ph.apiKey': 'Your API key',
          'btn.save': 'Save',
          'btn.refresh': 'Force Refresh',
          'hint.saveAnywhere': 'Save from any tab. "Force Refresh" reloads the selected screen.',
          'tab.general': 'General',
          'tab.theme': 'Theme & Layout',
          'tab.news': 'News',
          'tab.slideshow': 'Slideshow',
          'tab.web': 'Web Viewer',
          'tab.uploads': 'Uploads',
          'group.general': 'General',
          'group.theme': 'Theme & Layout',
          'group.news': 'News',
          'group.slideshow': 'Slideshow',
          'group.web': 'Web Viewer',
          'group.uploads': 'Uploads',
          'field.screenId': 'Screen ID',
          'field.timezone': 'Timezone',
          'field.weatherLocation': 'Weather Location',
          'field.theme': 'Theme',
          'opt.dark': 'dark',
          'opt.light': 'light',
          'field.layout': 'Layout',
          'opt.layout.default': 'default',
          'opt.layout.slideshow': 'slideshow',
          'opt.layout.vertical3': 'vertical-3',
          'opt.layout.news': 'news',
          'field.powerProfile': 'Power Profile',
          'opt.profile.performance': 'performance',
          'opt.profile.balanced': 'balanced',
          'opt.profile.visual': 'visual',
          'hint.profile': 'Profiles tune animations and effects:<br/>' +
            '<div><b>performance:</b> cut only, short duration, no auto-scroll, minimal effects</div>' +
            '<div><b>balanced:</b> fade/cut, medium duration, light Ken Burns</div>' +
            '<div><b>visual:</b> fade/wipe, longer duration, Ken Burns enabled</div>',
          'desc.theme': 'Choose a light or dark appearance for the admin and player widgets.',
          'desc.layout': 'Controls how modules are arranged on screen.',
          'desc.powerProfile': 'Optimizes animations/effects based on performance goal.',
          'desc.clock': 'Style of the clock shown in the player.',
          'desc.welcome': 'Text and color for the welcome line in slideshow layouts.',
          'desc.news': 'Tagesschau source, count and rotation duration of news items.',
          'desc.slideshow': 'Transition effects and duration between images.',
          'desc.web': 'Embedded website or snapshot, including auto-scroll and refresh intervals.',
          'desc.uploads': 'Manage uploaded images and add them to slides.',
          'field.clockType': 'Clock Type',
          'opt.clock.analog': 'analog',
          'opt.clock.digital': 'digital',
          'field.clockStyle': 'Clock Style',
          'opt.clock.classic': 'classic',
          'opt.clock.mono': 'mono',
          'opt.clock.glass': 'glass',
          'opt.clock.minimal': 'minimal',
          'opt.clock.neon': 'neon',
          'opt.clock.flip': 'flip',
          'field.welcomeText': 'Welcome Text',
          'field.welcomeColor': 'Welcome Text Color',
          'btn.applyColor': 'Apply color to selected text',
          'field.bottomBgColor': 'Bottom Widgets Background Color (slideshow)',
          'field.bottomBgImage': 'Bottom Widgets Background Image URL (slideshow)',
          'field.newsCategory': 'News Category (Tagesschau)',
          'opt.news.wirtschaft': 'wirtschaft',
          'opt.news.top': 'top',
          'field.newsLimit': 'News Limit',
          'field.newsRotationMs': 'News Rotation (ms)',
          'field.slideshowAnimations': 'Slideshow Animations',
          'field.animationDuration': 'Animation Duration (ms)',
          'group.autoScroll': 'Auto Scroll',
          'field.webUrl': 'Web Viewer URL',
          'field.webMode': 'Web Viewer Mode',
          'opt.web.iframe': 'iframe',
          'opt.web.snapshot': 'snapshot',
          'field.snapshotRefreshMs': 'Snapshot Refresh (ms)',
          'field.autoScrollEnabled': 'Auto Scroll',
          'opt.no': 'disabled',
          'opt.yes': 'enabled',
          'field.autoScrollMs': 'Auto Scroll Duration (ms)',
          'field.autoScrollDistance': 'Auto Scroll Distance (%)',
          'field.autoScrollStartDelay': 'Auto Scroll Start Delay (ms)',
          'group.refresh': 'Refresh & Rotation',
          'field.contentMs': 'Content Refresh (ms)',
          'field.rotateMs': 'Rotate Interval (ms)',
          'group.content': 'Content & Schedule',
          'field.schedule': 'Schedule (JSON array)',
          'desc.schedule': 'Time-based rules that override screen fields at specific times/days. Use short day names: mon, tue, wed, thu, fri, sat, sun. Start/end in 24h HH:MM. If end < start it spans midnight. First matching rule (top-most) wins.',
          'heading.example': 'Example',
          'example.schedule': '[\n  {\n    "days": ["mon","tue","wed","thu","fri"],\n    "start": "08:00",\n    "end": "12:00",\n    "overrides": {\n      "layout": "news",\n      "theme": "light",\n      "newsRotationMs": 6000\n    }\n  },\n  {\n    "days": ["sat","sun"],\n    "start": "00:00",\n    "end": "24:00",\n    "overrides": {\n      "layout": "slideshow",\n      "powerProfile": "visual",\n      "slideshowAnimations": ["fade","wipe"],\n      "slideshowAnimationDurationMs": 1200\n    }\n  }\n]',
          'field.slides': 'Slides (uploaded image URLs, JSON array)',
          'field.uploadSlides': 'Upload slides',
          'btn.upload': 'Upload',
          'hint.upload': 'Tip: Select multiple images to add them all at once. Uploaded files are served at /uploads/...',
          'heading.preview': 'Preview',
          'hint.previewNote': 'The preview loads /player/{Screen ID} in a small window. For live changes, save and refresh as needed.',
          'heading.edit': 'Edit Screen',
          'hint.slideshowAnims': 'Tip: Hold Ctrl/Cmd to select multiple animations. If multiple are selected, one will be chosen at random per transition.',
          'hint.saveForm': 'A valid API key is required to save.',
        }
      };

      function applyI18n(lang) {
        const dict = I18N[lang] || I18N.de;
        document.querySelectorAll('.i18n').forEach((el) => {
          const key = el.getAttribute('data-i18n');
          const htmlKey = el.getAttribute('data-i18n-html');
          const phKey = el.getAttribute('data-i18n-placeholder');
          if (htmlKey && dict[htmlKey]) el.innerHTML = dict[htmlKey];
          if (key && dict[key]) el.textContent = dict[key];
          if (phKey && dict[phKey]) {
            if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) el.placeholder = dict[phKey];
          }
        });
          const titleEl = document.querySelector('h1.i18n[data-i18n="title"]');
        if (titleEl && dict.title) titleEl.textContent = dict.title;
      }

      function fillForm(cfg, idFromList) {
        $('#screenId').value = cfg.screenId || idFromList || '';
            $('#timezone').value = cfg.timezone || '';
            $('#weatherLocation').value = cfg.weatherLocation || '';
            $('#webViewerUrl').value = cfg.webViewerUrl || '';
            $('#contentMs').value = cfg.refreshIntervals?.contentMs ?? 30000;
            $('#rotateMs').value = cfg.refreshIntervals?.rotateMs ?? 8000;
            $('#webViewerMode').value = cfg.webViewerMode || 'iframe';
            $('#snapshotRefreshMs').value = cfg.snapshotRefreshMs ?? 300000;
            $('#theme').value = cfg.theme || 'dark';
            $('#layout').value = cfg.layout || 'default';
            $('#powerProfile').value = cfg.powerProfile || 'balanced';
            $('#welcomeText').value = cfg.welcomeText || 'Herzlich Willkommen';
            $('#welcomeTextColor').value = cfg.welcomeTextColor || '#ffffff';
            $('#clockType').value = cfg.clockType || 'analog';
            $('#clockStyle').value = cfg.clockStyle || 'classic';
            $('#bottomWidgetsBgColor').value = cfg.bottomWidgetsBgColor || '#000000';
            $('#bottomWidgetsBgImage').value = cfg.bottomWidgetsBgImage || '';
            (function setAnims(){ const el = document.getElementById('slideshowAnimations'); if (!el) return; const vals = (cfg.slideshowAnimations||['fade']).map(String); Array.from(el.options).forEach(o=>o.selected = vals.includes(o.value)); })();
            document.getElementById('slideshowAnimationDurationMs').value = cfg.slideshowAnimationDurationMs ?? 900;
            document.getElementById('slideshowPreloadNext').checked = !!cfg.slideshowPreloadNext;
            document.getElementById('newsCategory').value = cfg.newsCategory || 'wirtschaft';
            document.getElementById('newsLimit').value = cfg.newsLimit ?? 8;
            document.getElementById('newsRotationMs').value = cfg.newsRotationMs ?? 8000;
            $('#autoScrollEnabled').value = String(!!cfg.autoScrollEnabled);
            $('#autoScrollMs').value = cfg.autoScrollMs ?? 30000;
            $('#autoScrollDistancePct').value = cfg.autoScrollDistancePct ?? 25;
            $('#autoScrollStartDelayMs').value = cfg.autoScrollStartDelayMs ?? 0;
            $('#schedule').value = JSON.stringify(cfg.schedule || [], null, 2);
            $('#slides').value = JSON.stringify(cfg.slides || [], null, 2);
            updatePreview();
            toggleSlideshowOnly();
      }

      function populateScreenPicker(screens) {
        const picker = document.getElementById('screenPicker');
        if (!picker) return;
        const cur = picker.value;
        picker.innerHTML = '<option value="">– Select screen –</option>';
        const ids = Object.keys(screens || {}).sort((a,b)=>a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
        ids.forEach(id => {
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = id;
          picker.appendChild(opt);
        });
        if (cur && ids.includes(cur)) picker.value = cur;
      }

      async function loadScreens() {
        const res = await fetch('/api/screens');
        const { screens } = await res.json();
        populateScreenPicker(screens);
      }

      // Tabs behavior
      document.querySelectorAll('.tabs .tab').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const target = /** @type {HTMLButtonElement} */ (e.currentTarget);
          const id = target.getAttribute('data-tab');
          if (!id) return;
          document.querySelectorAll('.tabs .tab').forEach((b) => b.classList.remove('tab-active'));
          target.classList.add('tab-active');
          document.querySelectorAll('.tab-panel').forEach((panel) => {
            if (panel.id === id) panel.classList.remove('hidden');
            else panel.classList.add('hidden');
          });
        });
      });

      // Screen picker behavior
      document.getElementById('screenPicker')?.addEventListener('change', async (e) => {
        const id = /** @type {HTMLSelectElement} */(e.target).value;
        if (!id) return;
        const cfg = await (await fetch(`/api/config/${encodeURIComponent(id)}`)).json();
        fillForm(cfg, id);
        // Keep the picker in sync with possibly edited screenId
        const pickerEl = document.getElementById('screenPicker');
        if ($('#screenId').value && pickerEl) {
          /** @type {HTMLSelectElement} */ (pickerEl).value = $('#screenId').value;
        }
      });

      document.getElementById('newScreenBtn')?.addEventListener('click', async () => {
        const id = prompt('Enter a new screen ID');
        if (!id) return;
        const cfg = await (await fetch(`/api/config/${encodeURIComponent(id)}`)).json();
        fillForm(cfg, id);
        // update picker list if needed
        try { await loadScreens(); } catch {}
        const picker = /** @type {HTMLSelectElement} */(document.getElementById('screenPicker'));
        if (picker) picker.value = id;
        document.getElementById('screenId')?.focus();
      });

      $('#editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const screenId = $('#screenId').value.trim();
        const payload = {
          screenId,
          timezone: $('#timezone').value.trim() || 'UTC',
          weatherLocation: $('#weatherLocation').value.trim() || 'London',
          webViewerUrl: $('#webViewerUrl').value.trim(),
          refreshIntervals: {
            contentMs: Number($('#contentMs').value) || 30000,
            rotateMs: Number($('#rotateMs').value) || 8000,
          },
          webViewerMode: ($('#webViewerMode').value || 'iframe'),
          snapshotRefreshMs: Number($('#snapshotRefreshMs').value) || 300000,
          theme: ($('#theme').value || 'dark'),
          powerProfile: ($('#powerProfile').value || 'balanced'),
          layout: ($('#layout').value || 'default'),
          welcomeText: $('#welcomeText').value || 'Herzlich Willkommen',
          welcomeTextColor: $('#welcomeTextColor').value || '#ffffff',
          clockType: $('#clockType').value || 'analog',
          clockStyle: $('#clockStyle').value || 'classic',
          bottomWidgetsBgColor: $('#bottomWidgetsBgColor').value || '',
          bottomWidgetsBgImage: $('#bottomWidgetsBgImage').value || '',
          slideshowAnimations: Array.from(document.getElementById('slideshowAnimations')?.selectedOptions || []).map(o=>o.value),
          slideshowAnimationDurationMs: Number(document.getElementById('slideshowAnimationDurationMs')?.value) || 900,
          slideshowPreloadNext: !!document.getElementById('slideshowPreloadNext')?.checked,
          newsCategory: (document.getElementById('newsCategory')?.value || 'wirtschaft'),
          newsLimit: Number(document.getElementById('newsLimit')?.value) || 8,
          newsRotationMs: Number(document.getElementById('newsRotationMs')?.value) || 8000,
          autoScrollEnabled: ($('#autoScrollEnabled').value === 'true'),
          autoScrollMs: Number($('#autoScrollMs').value) || 30000,
          autoScrollDistancePct: Number($('#autoScrollDistancePct').value) || 25,
          autoScrollStartDelayMs: Number($('#autoScrollStartDelayMs').value) || 0,
          schedule: JSON.parse($('#schedule').value || '[]'),
          slides: JSON.parse($('#slides').value || '[]'),
        };
        // Prefer top API key if present, fallback to bottom field
        const apiKey = ($('#apiKeyTop')?.value || $('#apiKey')?.value || '').trim();
        const res = await fetch(`/api/config/${encodeURIComponent(screenId)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(apiKey ? { 'X-Api-Key': apiKey } : {}),
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert('Failed to save: ' + res.status);
          return;
        }
        await loadScreens();
        alert('Saved');
      });

      // Upload handler
      $('#uploadBtn').addEventListener('click', async () => {
        const files = Array.from($('#fileInput').files || [])
        if (!files.length) return alert('Choose at least one image')
        const apiKey = ($('#apiKeyTop')?.value || $('#apiKey')?.value || '').trim();
        const uploaded = []
        try {
          $('#uploadBtn').disabled = true
          for (const f of files) {
            const fd = new FormData()
            fd.append('file', f)
            const res = await fetch('/api/uploads', { method: 'POST', headers: apiKey ? { 'X-Api-Key': apiKey } : {}, body: fd })
            if (!res.ok) throw new Error('Upload failed: ' + res.status)
            const { url } = await res.json()
            uploaded.push(url)
          }
          const arr = JSON.parse($('#slides').value || '[]')
          uploaded.forEach((u) => arr.push(u))
          $('#slides').value = JSON.stringify(arr, null, 2)
          alert('Uploaded ' + uploaded.length + ' file(s)')
        } catch (err) {
          alert(String(err?.message || err || 'Upload failed'))
        } finally {
          $('#uploadBtn').disabled = false
          $('#fileInput').value = ''
        }
      })

      function doRefresh(apiKey) {
        return fetch(`/api/push/${encodeURIComponent($('#screenId').value.trim())}/refresh`, {
          method: 'POST',
          headers: apiKey ? { 'X-Api-Key': apiKey } : {},
        });
      }

      $('#refreshBtn').addEventListener('click', async () => {
        const id = $('#screenId').value.trim();
        if (!id) return alert('Set Screen ID first');
        const apiKey = ($('#apiKeyTop')?.value || $('#apiKey')?.value || '').trim();
        const res = await doRefresh(apiKey);
        if (!res.ok) return alert('Failed to push refresh');
        alert('Refresh pushed');
      });

      document.getElementById('refreshBtnTop')?.addEventListener('click', async () => {
        const id = $('#screenId').value.trim();
        if (!id) return alert('Set Screen ID first');
        const apiKey = ($('#apiKeyTop')?.value || $('#apiKey')?.value || '').trim();
        const res = await doRefresh(apiKey);
        if (!res.ok) return alert('Failed to push refresh');
        alert('Refresh pushed');
      });

      // Apply inline color to selected part of Welcome Text
      $('#applyWelcomeColorBtn').addEventListener('click', () => {
        const input = /** @type {HTMLInputElement} */ (document.getElementById('welcomeText'))
        const color = /** @type {HTMLInputElement} */ (document.getElementById('welcomeTextColor'))
        if (!input || !color) return
        const val = input.value || ''
        const start = input.selectionStart ?? 0
        const end = input.selectionEnd ?? 0
        if (start === end) { alert('Select the part of the text you want to color first.'); return }
        const sel = val.slice(start, end)
        const c = (color.value || '#ffffff').trim()
        const before = val.slice(0, start)
        const after = val.slice(end)
        const tag = `{#${c.replace(/^#/, '')}}${sel}{/}`
        const next = before + tag + after
        input.value = next
        // Restore focus and selection around the colored segment
        input.focus()
        const newStart = before.length
        const newEnd = newStart + tag.length
        try { input.setSelectionRange(newStart, newEnd) } catch {}
      })

      // Live preview
      function clockPreviewAnalog(style, theme) {
        const box = document.getElementById('clockPreview');
        if (!box) return; box.innerHTML = '';
        const size = 140; const r = size/2; const ring = r - 10;
        const svgNS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('viewBox', `0 0 ${size} ${size}`); svg.style.width = '160px'; svg.style.height = '160px';
        const isLight = theme === 'light';
        let bg = isLight ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.35)';
        let tick = isLight ? '#444' : '#666';
        let hour = isLight ? '#222' : '#fff';
        let minute = isLight ? '#444' : '#ddd';
        let second = isLight ? '#e33' : '#ff4d4d';
        if (style === 'mono') { const ink = isLight ? '#222' : '#fff'; bg = isLight ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.35)'; tick=hour=minute=second=ink; }
        if (style === 'glass') { bg = isLight ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.25)'; tick = isLight ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.6)'; hour = isLight ? '#333' : '#fff'; minute = isLight ? '#555' : '#ddd'; second = isLight ? '#e33' : '#ff5757'; }
        const circle = document.createElementNS(svgNS, 'circle'); circle.setAttribute('cx', String(r)); circle.setAttribute('cy', String(r)); circle.setAttribute('r', String(r)); circle.setAttribute('fill', bg); circle.setAttribute('stroke', 'rgba(0,0,0,0.4)'); circle.setAttribute('stroke-width','2'); svg.appendChild(circle);
        for (let i=0;i<60;i++){ const len = i%5===0?10:5; const line = document.createElementNS(svgNS,'line'); const a=i*Math.PI/30; const x1=r+Math.sin(a)*(ring-len); const y1=r-Math.cos(a)*(ring-len); const x2=r+Math.sin(a)*ring; const y2=r-Math.cos(a)*ring; line.setAttribute('x1',x1.toFixed(1)); line.setAttribute('y1',y1.toFixed(1)); line.setAttribute('x2',x2.toFixed(1)); line.setAttribute('y2',y2.toFixed(1)); line.setAttribute('stroke',tick); line.setAttribute('stroke-width', i%5===0?'3':'2'); svg.appendChild(line);}        
        const hourHand = document.createElementNS(svgNS,'line'); const minuteHand = document.createElementNS(svgNS,'line'); const secondHand = document.createElementNS(svgNS,'line');
        [hourHand,minuteHand,secondHand].forEach((l)=>{ l.setAttribute('x1',String(r)); l.setAttribute('y1',String(r)); l.setAttribute('stroke-linecap','round'); })
        hourHand.setAttribute('stroke',hour); hourHand.setAttribute('stroke-width','6');
        minuteHand.setAttribute('stroke',minute); minuteHand.setAttribute('stroke-width','4');
        secondHand.setAttribute('stroke',second); secondHand.setAttribute('stroke-width','2');
        svg.appendChild(hourHand); svg.appendChild(minuteHand); svg.appendChild(secondHand);
        const tickFn = ()=>{ const d=new Date(); const h=d.getHours()%12; const m=d.getMinutes(); const s=d.getSeconds(); const sDeg=s/60*360; const mDeg=(m+s/60)/60*360; const hDeg=(h+m/60)/12*360; const set=(el,deg,len)=>{ const rad=(deg-90)*Math.PI/180; const x=r+Math.cos(rad)*(ring*len); const y=r+Math.sin(rad)*(ring*len); el.setAttribute('x2',String(x)); el.setAttribute('y2',String(y)); }; set(hourHand,hDeg,0.55); set(minuteHand,mDeg,0.78); set(secondHand,sDeg,0.9); };
        tickFn(); setInterval(tickFn, 500);
        box.appendChild(svg);
      }

      function clockPreviewDigital(style) {
        const box = document.getElementById('clockPreview'); if (!box) return; box.innerHTML='';
        const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.justifyContent='center'; wrap.style.height='100%';
        const timeStr = ()=> new Intl.DateTimeFormat('de-DE',{ hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(new Date());
        if (style==='neon') { const el = document.createElement('div'); el.style.fontFamily='monospace'; el.style.fontWeight='700'; el.style.fontSize='48px'; el.style.color='#00e5ff'; el.style.textShadow='0 0 8px #00e5ff80, 0 0 16px #00e5ff80'; el.textContent=timeStr(); wrap.appendChild(el); setInterval(()=> el.textContent=timeStr(), 500); }
        else if (style==='flip') { const root=document.createElement('div'); root.style.display='flex'; root.style.alignItems='center'; const mk=(t)=>{ const d=document.createElement('div'); d.style.background='#111'; d.style.color='#fff'; d.style.borderRadius='6px'; d.style.padding='6px 10px'; d.style.margin='0 4px'; d.style.fontFamily='monospace'; d.style.fontSize='40px'; d.style.boxShadow='0 2px 8px rgba(0,0,0,0.4)'; d.textContent=t; return d; }; const update=()=>{ const now=new Date(); const f=new Intl.DateTimeFormat('de-DE',{ hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(now); const [h,m,s]=f.split(':'); root.innerHTML=''; root.appendChild(mk(h)); root.appendChild(document.createTextNode(':')); root.appendChild(mk(m)); root.appendChild(document.createTextNode(':')); root.appendChild(mk(s)); }; update(); setInterval(update,500); wrap.appendChild(root); }
        else { const el=document.createElement('div'); el.style.fontFamily='ui-rounded, SF Pro Rounded, Segoe UI, Roboto, system-ui'; el.style.fontWeight='700'; el.style.fontSize='44px'; el.style.color='#fff'; el.style.letterSpacing='1px'; el.textContent=timeStr(); wrap.appendChild(el); setInterval(()=> el.textContent=timeStr(), 500) }
        box.appendChild(wrap);
      }

      function renderColoredText(raw, defaultColor) {
        const container = document.createElement('span');
        const pattern = /\{#([0-9a-fA-F]{3,8}|[a-zA-Z]+)\}([\s\S]*?)\{\/\}/g;
        let lastIndex = 0; let m;
        while ((m = pattern.exec(raw))) {
          const [full, color, text] = m;
          if (m.index > lastIndex) container.appendChild(document.createTextNode(raw.slice(lastIndex, m.index)));
          const span = document.createElement('span');
          const c = color.startsWith('#') ? color : (/^[a-zA-Z]+$/.test(color) ? color : ('#' + color));
          span.style.color = c; span.textContent = text; container.appendChild(span);
          lastIndex = m.index + full.length;
        }
        if (lastIndex < raw.length) container.appendChild(document.createTextNode(raw.slice(lastIndex)));
        if (!container.childNodes.length) { const s=document.createElement('span'); s.style.color=defaultColor; s.textContent=raw; container.appendChild(s) }
        return container;
      }

      function updatePreview() {
        const type = document.getElementById('clockType')?.value || 'analog';
        const style = document.getElementById('clockStyle')?.value || (type==='digital' ? 'minimal' : 'classic');
        const theme = document.getElementById('theme')?.value || 'dark';
        const welcome = document.getElementById('welcomeText')?.value || 'Herzlich Willkommen';
        const color = (document.getElementById('welcomeTextColor')?.value || '#ffffff');
        const bgCol = (document.getElementById('bottomWidgetsBgColor')?.value || '');
        const bgImg = (document.getElementById('bottomWidgetsBgImage')?.value || '');
        // Update player preview with a live config (no save required)
        const ifr = document.getElementById('playerPreview');
        if (ifr) {
          // Keep URL fixed to the preview route; we postMessage config below
          const loc = window.location;
          const proto = loc.protocol;
          const host = loc.hostname;
          const cur = loc.port ? `${proto}//${host}:${loc.port}` : `${proto}//${host}`;
          let base = cur;
          if (loc.port !== '5173' && loc.port !== '8080') {
            base = `${proto}//${host}:5173`;
          }
          const desiredSrc = `${base}/preview`;
          if ((/** @type {HTMLIFrameElement} */ (ifr)).src !== desiredSrc) {
            /** @type {HTMLIFrameElement} */ (ifr).src = desiredSrc;
          }
          // Build a transient config from the current form values
          const cfg = {
            screenId: document.getElementById('screenId')?.value || 'preview',
            timezone: document.getElementById('timezone')?.value || 'UTC',
            weatherLocation: document.getElementById('weatherLocation')?.value || 'London',
            webViewerUrl: document.getElementById('webViewerUrl')?.value || '',
            webViewerMode: document.getElementById('webViewerMode')?.value || 'iframe',
            snapshotRefreshMs: Number(document.getElementById('snapshotRefreshMs')?.value) || 300000,
            theme: document.getElementById('theme')?.value || 'dark',
            layout: document.getElementById('layout')?.value || 'default',
            welcomeText: document.getElementById('welcomeText')?.value || 'Herzlich Willkommen',
            welcomeTextColor: document.getElementById('welcomeTextColor')?.value || '#ffffff',
            clockType: document.getElementById('clockType')?.value || 'analog',
            clockStyle: document.getElementById('clockStyle')?.value || 'classic',
            bottomWidgetsBgColor: document.getElementById('bottomWidgetsBgColor')?.value || '',
            bottomWidgetsBgImage: document.getElementById('bottomWidgetsBgImage')?.value || '',
            slideshowAnimations: Array.from(document.getElementById('slideshowAnimations')?.selectedOptions || []).map(o=>o.value),
            slideshowAnimationDurationMs: Number(document.getElementById('slideshowAnimationDurationMs')?.value) || 900,
            powerProfile: document.getElementById('powerProfile')?.value || 'balanced',
            slideshowPreloadNext: !!document.getElementById('slideshowPreloadNext')?.checked,
            newsCategory: document.getElementById('newsCategory')?.value || 'wirtschaft',
            newsLimit: Number(document.getElementById('newsLimit')?.value) || 8,
            newsRotationMs: Number(document.getElementById('newsRotationMs')?.value) || 8000,
            refreshIntervals: {
              contentMs: Number(document.getElementById('contentMs')?.value) || 30000,
              rotateMs: Number(document.getElementById('rotateMs')?.value) || 8000,
            },
            autoScrollEnabled: (document.getElementById('autoScrollEnabled')?.value === 'true'),
            autoScrollMs: Number(document.getElementById('autoScrollMs')?.value) || 30000,
            autoScrollDistancePct: Number(document.getElementById('autoScrollDistancePct')?.value) || 25,
            autoScrollStartDelayMs: Number(document.getElementById('autoScrollStartDelayMs')?.value) || 0,
            schedule: JSON.parse(document.getElementById('schedule')?.value || '[]'),
            slides: JSON.parse(document.getElementById('slides')?.value || '[]'),
          };
          // Post config now and again shortly after, to cover fresh iframe loads
          const send = () => { try { (ifr.contentWindow || window).postMessage({ type: 'previewConfig', config: cfg }, '*') } catch {} };
          send();
          setTimeout(send, 100);
          setTimeout(send, 300);
        }
        // Fill example schedule snippet
        const ex = document.querySelector('pre.i18n[data-i18n="example.schedule"]');
        if (ex) {
          const langSel = document.getElementById('langPicker');
          const lang = (langSel && langSel.value) || 'de';
          const dict = I18N[lang] || I18N.de;
          ex.textContent = dict['example.schedule'] || '';
        }
      }

      ['clockType','clockStyle','theme','welcomeText','welcomeTextColor','bottomWidgetsBgColor','bottomWidgetsBgImage','layout','webViewerMode','snapshotRefreshMs','newsCategory','newsLimit','newsRotationMs','contentMs','rotateMs','autoScrollEnabled','autoScrollMs','autoScrollDistancePct','autoScrollStartDelayMs','schedule','slides','webViewerUrl','weatherLocation','timezone','powerProfile'].forEach((id)=>{
        const el = document.getElementById(id); if (el) el.addEventListener('input', updatePreview)
      })
      // Keep preview in sync with Screen ID changes
      document.getElementById('screenId')?.addEventListener('input', updatePreview)
      document.getElementById('layout')?.addEventListener('change', () => { toggleSlideshowOnly(); updatePreview(); })

      function toggleSlideshowOnly() {
        const layoutVal = (document.getElementById('layout')?.value || 'default')
        const isShow = layoutVal === 'slideshow'
        // Effects apply to both slideshow and news (as both use slideshow component)
        const showEffects = layoutVal === 'slideshow' || layoutVal === 'news'
        document.querySelectorAll('.slideshow-only').forEach((el) => {
          el.classList.toggle('hidden', !isShow)
        })
        document.querySelectorAll('.slideshow-effects').forEach((el) => {
          el.classList.toggle('hidden', !showEffects)
        })
      }

      // Initial preview + toggle + language
      updatePreview();
      toggleSlideshowOnly();
      const defaultLang = 'de';
      document.getElementById('langPicker').value = defaultLang;
      applyI18n(defaultLang);

      loadScreens();
      document.getElementById('langPicker')?.addEventListener('change', (e) => {
        const lang = /** @type {HTMLSelectElement} */ (e.target).value || 'de';
        applyI18n(lang);
        updatePreview();
      });

      document.getElementById('bottomBgUploadBtn')?.addEventListener('click', async () => {
        const fileInput = /** @type {HTMLInputElement} */ (document.getElementById('bottomBgFile'))
        const f = fileInput?.files?.[0]
        if (!f) return alert('Choose an image first')
        const apiKey = document.getElementById('apiKey')?.value?.trim() || ''
        const fd = new FormData(); fd.append('file', f)
        const res = await fetch('/api/uploads', { method: 'POST', headers: apiKey ? { 'X-Api-Key': apiKey } : {}, body: fd })
        if (!res.ok) return alert('Upload failed')
        const { url } = await res.json()
        const urlInput = /** @type {HTMLInputElement} */ (document.getElementById('bottomWidgetsBgImage'))
        urlInput.value = url
        fileInput.value = ''
        updatePreview()
      })
    </script>
  </body>
  </html>


